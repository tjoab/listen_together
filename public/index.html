<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Listen Together</title>
		<script src="/socket.io/socket.io.js"></script>
		<style>
			body {
				font-family: Arial, sans-serif;
				text-align: center;
				margin: 50px;
			}
			button {
				padding: 10px 20px;
				font-size: 18px;
			}
		</style>
	</head>
	<body>
		<h1>Listen Together</h1>
		<audio id="audioPlayer" controls preload="auto" style="display: none">
			<source
				src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"
				type="audio/mpeg"
			/>
			Your browser does not support the audio element.
		</audio>
		<br /><br />
		<button id="startButton" style="display: none">Ready Up</button>

		<script>
			const audio = document.getElementById("audioPlayer");
			const startButton = document.getElementById("startButton");
			const socket = io();
			let isPlaying = false;
			let isSeeking = false;

			socket.on("usersConnected", () => {
				startButton.style.display = "block";
			});
			socket.on("usersDisconnected", () => {
				startButton.style.display = "none";
				audio.style.display = "none";
			});

			// ios interaction (does it need to be with audio player or anything?)
			startButton.addEventListener("click", () => {
				startButton.style.color = "#666";
				socket.emit("userReady");
			});

			socket.on("allReady", () => {
				audio.style.display = "block";
			});

			audio.addEventListener("play", () => {
				if (!isPlaying) {
					isPlaying = true;
					socket.emit("play");
				}
			});

			audio.addEventListener("pause", () => {
				if (isPlaying) {
					isPlaying = false;
					socket.emit("pause");
				}
			});

			audio.addEventListener("seeked", () => {
				if (!isSeeking) {
					socket.emit("seek", audio.currentTime);
				}
				// Reset flag after second client wants to loop the broadcasts
				isSeeking = false;
			});

			socket.on("play", () => {
				isPlaying = true;
				audio.play();
			});

			socket.on("pause", () => {
				isPlaying = false;
				audio.pause();
			});

			socket.on("seek", (currentTime) => {
				isSeeking = true;
				audio.currentTime = currentTime;
			});
		</script>
	</body>
</html>
